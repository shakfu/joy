(* BLAS Benchmark - Compare performance with and without BLAS *)
(* Run with: ./build/joy tests/blas_benchmark.joy *)
(* Build without BLAS: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release *)
(* Build with BLAS:    cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DJOY_BLAS=ON *)

"=== BLAS Benchmark ===" .
"" .

(* Correctness verification *)
"Verifying correctness:" .
"  mm [[1 2] [3 4]] [[5 6] [7 8]]: " .
[[1 2] [3 4]] [[5 6] [7 8]] mm .
"  Expected: [[19 22] [43 50]]" .
"  mv [[1 2] [3 4]] [1 2]: " .
[[1 2] [3 4]] [1 2] mv .
"  Expected: [5 11]" .
"" .

(* Matrix multiply benchmarks - O(n^3), benefits most from BLAS *)
"Matrix Multiply (mm) - O(n^3):" .

"  50x50 x100:   " .
clock
100 [1 50 vrange [pop 1 50 vrange] map dup mm pop] times
clock swap - . " ms" .

"  100x100 x20:  " .
clock
20 [1 100 vrange [pop 1 100 vrange] map dup mm pop] times
clock swap - . " ms" .

"  200x200 x5:   " .
clock
5 [1 200 vrange [pop 1 200 vrange] map dup mm pop] times
clock swap - . " ms" .

"" .

(* Matrix-vector benchmarks - O(n^2), less benefit from BLAS *)
"Matrix-Vector (mv) - O(n^2):" .

"  50x50 x500:   " .
clock
500 [1 50 vrange [pop 1 50 vrange] map 1 50 vrange mv pop] times
clock swap - . " ms" .

"  100x100 x200: " .
clock
200 [1 100 vrange [pop 1 100 vrange] map 1 100 vrange mv pop] times
clock swap - . " ms" .

"  200x200 x50:  " .
clock
50 [1 200 vrange [pop 1 200 vrange] map 1 200 vrange mv pop] times
clock swap - . " ms" .

"" .
"=== Benchmark Complete ===" .

(* Expected results with BLAS (Apple Accelerate, M1/M2 Mac):
 *   mm 50x50:   ~5ms   (vs ~10ms without BLAS) - 2x speedup
 *   mm 100x100: ~5ms   (vs ~21ms without BLAS) - 4x speedup
 *   mm 200x200: ~5ms   (vs ~40ms without BLAS) - 8x speedup
 *   mv: Similar times with/without BLAS (conversion overhead dominates)
 *)
